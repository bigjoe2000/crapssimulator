<html>
    <head>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ext-language_tools.js"></script>
        
        <script src="craps.js"></script>
        <script>
            google.charts.load('current', {'packages':['corechart']});
            let strategiesAvailable = {
                passline : passline, 
                passline_odds : passline_odds, 
                passline_maxodds : passline_maxodds, 
                dontpass : dontpass, 
                dontpass_odds : dontpass_odds, 
                place5689 : place5689, 
                ironcross : ironcross, 
                hammerlock : hammerlock, 
                buy_4_10 : buy_4_10,
                hardways : hardways, 
                pass_dontpass_horn12 : pass_dontpass_horn12, 
                pass_2come : pass_2come, 
                mike_harris : mike_harris,
                pass_dontpass : pass_dontpass,
                frank_dontpassdontcome_odds_68: frank_dontpassdontcome_odds_68,
                mikeharrisno59: mikeharrisno59,
                custom: custom
            }

            removeChildren = function(el, leaveSome) {
                let n = leaveSome || 0;
                while(el.children.length > n) {
                    el.removeChild(el.lastChild);
                }
            }

            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });
   
        </script>
        <style>
            .run {
                border: 1px solid black;
            }
            pre {
                padding: 8px;
            }
            .center {
                width: 50%;
                margin: auto;
            }
            .hidden {
                display: none;
            }
            div.custom {
                width: 50%;
                min-height: 600px;
                height: 100%;
                position: relative;
            }
            .flex {
                display: flex;
            }
            .editor {
                display: block;
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }
        </style>
    </head>
    <body>
        <div><label>Strategies to test</label>
            <div class="strategies">

            </div>
        </div>
        <button class="custom">Show/Hide Custom</button>
        <div class="custom-wrapper hidden">
            <div class="flex">
                <div class="custom">
                    <pre class="editor">
                    </pre>
                </div>
                <pre class="instructions">
player, table, and unit are passed to the method you are defining
player {
    bankroll: the current bankroll
    startingBankroll: the amount of money the player started with
    getBet(betName, betNumber) - betNumber is optional. betName is one of Place, Buy, Come, Odds, LayOdds, LayOdds
    betsOnTable: an array of bets player currenty has on the table
    bet(Bet object): place this bet
    strategyInfo: {
        stopped: if set to true, no more bets will be placed
        currentShooter {
            betsWon: a list of bets won
        }
    }
}

table {
    shooterRolls: the number of rolls current shooter has made
    numberOfShooters: the number of shooters that have gone in the current session
    point: The current point
    hasPoint(): Whether or not the table has a point
}

unit: current amount of table minimum

new Place(20, 5)  - Place the 5 for $20
new Buy(21, 4) - Place the 4 for $20 ($1 commission paid up front)
new Hop(5, "16") - Hop the 7 (1,6) for $5
new Odds(20, 4) - Place an Odds bet on 4 for $20 (assumes Pass/Come exists)
new Come(5) - Bet $5 on Come
new Pass(5) - Bet $5 on Pass line
new DontPass(5) - Bet $5 on Dont Pass line
new LayOdds(40, 4) - Lay $40 odds on 4 (assumes DontPass/DontCome exists)
new DontCome(5) - Bet $5 on DontCome
this.dontOddsStrategy.update(player, table, unit) - Run another strategy along with this one
calculateOddsBet(number, unit, oddsMultiple) - Calculates max odds where oddsMultiple is a the number of odds or the string '345' for max odds on 4/10,5/9,6/8 respectively
calculateLayOddsBet(number, unit, oddsMultiple) - Calculates max lay odds where oddsMultiple is a the number of odds or the string '345' for max odds on 4/10,5/9,6/8 respectively
                </pre>
            </div>
        </div>
        <hr>
        <div><label>Number of Runs</label><input type="number" name="numberOfRuns" value="2000"></div>
        <div><label>Max Rolls</label><input type="number" name="maxRolls" value="100"></div>
        <div><label>Max Shooters</label><input type="number" name="maxShooters" value="15"></div>
        <div><label>Bankroll</label><input type="number" name="bankroll" value="1000"></div>
        <div><label>Debug one run only</label><input type="checkbox" name="once"></div>
        <button class="doit">Do It</button>
        <div class="status"></div>
        <div class="printout"></div>
        <div class="chart"></div>
        <hr>
        <p>Update the contents of the textarea and select custom strategy above to see how it performs.</p>
        <script>
            const customEl = document.querySelector('div.custom-wrapper');
            const editor = window.ace.edit(customEl.querySelector('.editor'));
            editor.setTheme(`ace/theme/monokai`);
            editor.session.setMode(`ace/mode/javascript`);
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true,
                wrap: true,
                showLineNumbers: true
            });
            editor.on('change', data => {
            console.log('edited result', data);
            });

        let strategiesEl = document.querySelector('div.strategies');
        let logEl = document.querySelector('div.printout');
        let statusEl = document.querySelector('div.status');
        document.querySelector('button.doit').addEventListener('click', setItUp);
        document.querySelector('button.custom').addEventListener('click', ()=>customEl.classList.toggle('hidden'));

        Object.keys(strategiesAvailable).forEach(s=>{
            let wrapperEl = document.createElement('div');
            strategiesEl.appendChild(wrapperEl);

            let el = document.createElement('input');
            el.type="checkbox";
            el.value = s;
            wrapperEl.appendChild(el);
            el = document.createElement('span');
            el.innerText = s + ' - ' + strategiesAvailable[s].description() + ' ';
            wrapperEl.appendChild(el);
            if (s != 'custom') {
                el = document.createElement('button');
                el.innerText = 'Edit Custom';
                wrapperEl.appendChild(el);
                el.addEventListener('click', ()=>{
                    customEl.classList.remove('hidden');
                    let lines = new strategiesAvailable[s]().update.toString().split('\n');
                    // remove first line
                    lines.splice(0,1);
                    // remove last line
                    lines.splice(lines.length-1,1);
                    editor.setValue(lines.join('\n'));
                })
            }

        }) 

        function setItUp() {
            removeChildren(logEl);
            logs = [];

            if (!document.querySelector('input[name=once]').checked) {
                statusEl.innerText = 'Running Simulation';
            }
            setTimeout(doIt, 0);
        }

        function doIt() {
            let title = 'Strategy Comparison ' + new Date().toString() + ' ';
            let strategies = [];
            strategiesEl.querySelectorAll('input[type=checkbox]:checked').forEach(el=>{
                let strategy = new strategiesAvailable[el.value]();
                strategies.push(strategy);
                if (el.value == 'custom') {
                    strategy.update = Function("player", "table", "unit", "strategyInfo", editor.getValue());
                }
            });

            if (strategies.length == 0) {
                strategies = [new passline()];
            }
            let config = {
                numberOfRuns : document.querySelector('input[name=numberOfRuns]').value,
                maxRolls : document.querySelector('input[name=maxRolls]').value,
                maxShooters : document.querySelector('input[name=maxShooters]').value,
                bankroll : document.querySelector('input[name=bankroll]').value,
                'strategies' : strategies
            }
            let sim = new Simulation(config.numberOfRuns, config.maxRolls, config.maxShooters, config.bankroll, strategies);

            if (document.querySelector('input[name=once]').checked) {
                sim.printout();
                let line;
                while (logs.length) {
                    let el = document.createElement('div');
                    el.innerText = logs.shift();
                    logEl.appendChild(el);
                };
                return;
            }

            // Output is a dict of strategy names whose values are arrays of the form [simulationId, endingBankroll, StartingBankRoll, numberOfRoll]
            let output = sim.run();
            console.log(output);

            var data = new google.visualization.DataTable();
			data.addColumn('number', 'Win Amount');

            // Summarized will be dict of strategy names with values of dicts of ending backroll to number of times that occurred
            let summarized = {};
            let stats = {};
            let totals = {};
            let winCounts = {};
            let winTotals = {};
            let lossTotals = {};
            let max = -1;
            let min = Number.MAX_SAFE_INTEGER;
            Object.keys(output).forEach(k=>{
                data.addColumn('number', k);
                stats[k] = {
                    totals : 0,
                    winCounts : 0,
                    winTotals : 0,
                    lossCounts : 0,
                    lossTotals : 0
                }
                console.log('summarizing:' + k);
                summarized[k] = {};
                output[k].forEach(array=>{
                    let winAmount = parseInt(array[1]) - parseInt(array[2]);
                    summarized[k][winAmount] = summarized[k][winAmount] || 0;
                    summarized[k][winAmount] += 1;
                    stats[k]['totals'] += winAmount;
                    if (winAmount > 0) {
                        stats[k]['winCounts'] += 1;
                        stats[k]['winTotals'] += winAmount;
                    } else if (winAmount < 0) {
                        stats[k]['lossCounts'] += 1;
                        stats[k]['lossTotals'] += winAmount;
                    }
                    max = Math.max(max, winAmount);
                    min = Math.min(min, winAmount);
                })
            })

            console.log("Stats:");
            console.log(stats);
            console.log("Summarized:");
            console.log(summarized);

            for (let i = min; i <= max; i++) {
                let row = [i];
                Object.keys(output).forEach(k=>{
                    row.push(summarized[k][i] || null);
                })
                data.addRow(row);
            };
            google.charts.setOnLoadCallback(drawChart.bind(null, data, title, config, stats));
            statusEl.innerText = '';
        }

        function drawChart(data, title, config, stats) {
            //data = google.visualization.arrayToDataTable(data);
            let parentEl = document.querySelector('div.chart');
            let runEl = parentEl.insertBefore(document.createElement('div'), parentEl.firstChild);
            runEl.classList.add('run');
            let titleEl = runEl.appendChild(document.createElement('h2'));
            titleEl.innerText = title;
            titleEl.classList.add('center');
            let configEl = runEl.appendChild(document.createElement('pre'));
            let strategyNames = [];
            config.strategies.forEach(s=>
            strategyNames.push(s.constructor.name));
            config.strategies = strategyNames;
            configEl.innerText = JSON.stringify(config, null, 2);
            configEl.classList.add('center');
            let summaryEl = runEl.appendChild(document.createElement('table'));
            summaryEl.classList.add('center');
            let headEl = summaryEl.appendChild(document.createElement('tr'));
            headEl.appendChild(document.createElement('th')).innerText = 'Strategy Name';
            headEl.appendChild(document.createElement('th')).innerText = 'Average Win/Loss';
            headEl.appendChild(document.createElement('th')).innerText = 'Win Count';
            headEl.appendChild(document.createElement('th')).innerText = 'Win Average';
            headEl.appendChild(document.createElement('th')).innerText = 'Loss Count';
            headEl.appendChild(document.createElement('th')).innerText = 'Loss Average';
            
            config.strategies.forEach(s=>{
                let rowEl = summaryEl.appendChild(document.createElement('tr'));
                rowEl.appendChild(document.createElement('td')).innerText = s;
                rowEl.appendChild(document.createElement('td')).innerText = formatter.format(stats[s]['totals'] / config.numberOfRuns);
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['winCounts'];
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['winCounts'] == 0 ? formatter.format(0) : formatter.format(stats[s]['winTotals'] / stats[s]['winCounts']);
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['lossCounts'];
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['lossCounts'] == 0 ? formatter.format(0) : formatter.format(stats[s]['lossTotals'] / stats[s]['lossCounts']);
            })

            new google.visualization.LineChart(runEl.appendChild(document.createElement('div'), parentEl.firstChild)).draw(data, {
                curveType: 'function',
                legend: 'bottom',
                height: 400,
                interpolateNulls: true
            });
        }
        </script>
    </body>
</html>
