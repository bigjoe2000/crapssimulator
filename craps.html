<html>
    <head>
        <script async src="includes.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ext-language_tools.js"></script>
        
        <script src="craps.js"></script>
        <script>
            google.charts.load('current', {'packages':['corechart']});
            removeChildren = function(el, leaveSome) {
                let n = leaveSome || 0;
                while(el.children.length > n) {
                    el.removeChild(el.lastChild);
                }
            }

            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });
   
        </script>
        <style>
            .run {
                border: 1px solid black;
            }
            pre {
                padding: 8px;
            }
            .center {
                width: 50%;
                margin: auto;
            }
            .hidden {
                display: none;
            }
            div.custom {
                height: 100%;
                position: relative;
            }
            .flex {
                display: flex;
            }
            .editor {
                display: block;
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                margin: 8px;
            }
            i.info-button {
                cursor: pointer;
            }
            div.info-modal pre {
                white-space: pre-wrap;       /* Since CSS 2.1 */
                white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
                white-space: -pre-wrap;      /* Opera 4-6 */
                white-space: -o-pre-wrap;    /* Opera 7 */
                word-wrap: break-word;       /* Internet Explorer 5.5+ */
            }
        </style>
    </head>
    <body>



        <div>
            <label>Strategies to test</label>
            <div class="strategies row row-cols-1 row-cols-md-2 align-items-center justify-content-center gap-2 border-0">

            </div>
        </div>

        <div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="tutorialModalLabel">Javascript Help</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre>
                    player, table, and unit are passed to the method you are defining
                    player {
                        bankroll: the current bankroll
                        startingBankroll: the amount of money the player started with
                        getBet(betName, betNumber) - betNumber is optional. betName is one of Place, Buy, Come, Odds, LayOdds, LayOdds
                        betsOnTable: an array of bets player currenty has on the table
                        bet(Bet object): place this bet
                        strategyInfo: {
                            stopped: if set to true, no more bets will be placed
                            currentShooter {
                                betsWon: a list of bets won
                                betsLost: a list of bets lossm
                                betsPush: a list of bets pushed
                            }
                        }
                    }
                    
                    table {
                        shooterRolls: the number of rolls current shooter has made
                        numberOfShooters: the number of shooters that have gone in the current session
                        point: The current point
                        hasPoint(): Whether or not the table has a point
                    }
                    
                    unit: current amount of table minimum
                    
                    new Place(20, 5)  - Place the 5 for $20
                    new Buy(21, 4) - Place the 4 for $20 ($1 commission paid up front)
                    new Hop(5, "16") - Hop the 7 (1,6) for $5
                    new Odds(20, 4) - Place an Odds bet on 4 for $20 (assumes Pass/Come exists)
                    new Come(5) - Bet $5 on Come
                    new Pass(5) - Bet $5 on Pass line
                    new DontPass(5) - Bet $5 on Dont Pass line
                    new LayOdds(40, 4) - Lay $40 odds on 4 (assumes DontPass/DontCome exists)
                    new DontCome(5) - Bet $5 on DontCome
                    this.dontOddsStrategy.update(player, table, unit) - Run another strategy along with this one
                    calculateOddsBet(number, unit, oddsMultiple) - Calculates max odds where oddsMultiple is a the number of odds or the string '345' for max odds on 4/10,5/9,6/8 respectively
                    calculateLayOddsBet(number, unit, oddsMultiple) - Calculates max lay odds where oddsMultiple is a the number of odds or the string '345' for max odds on 4/10,5/9,6/8 respectively
                </pre></div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tutorialModal">Javascript Help</button>
        <hr>
        <div><label>Number of Runs</label><input type="number" name="numberOfRuns" value="2000"></div>
        <div><label>Max Rolls</label><input type="number" name="maxRolls" value="100"></div>
        <div><label>Max Shooters</label><input type="number" name="maxShooters" value="15"></div>
        <div><label>Bankroll</label><input type="number" name="bankroll" value="1000"></div>
        <div><label>Debug one run only</label><input type="checkbox" name="once"></div>
        <button class="doit">Do It</button>
        <div class="status"></div>
        <div class="printout"></div>
        <div class="chart"></div>
        <div class="templates hidden">
            <div class="card strategy-item" style="width: 18rem;">
                <div class="card-body">
                  <h5 class="card-title strategy-name">Card title</h5>
                  <i class="bi bi-info-circle info-button"></i>
                  <small class="opacity-50 text-nowrap is-system"></small>
                  <input class="hidden" type="checkbox">
                  </div>
            </div>
            <div class="modal fade info-modal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5 strategy-name" >Strategy Name</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <h6 class="strategy-description"></h6>
                        <pre class="strategy-content">
    
                        </pre>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary edit-button" data-bs-dismiss="modal">Edit</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                </div>
            </div>
            <div class="modal fade edit-modal">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5 strategy-name" >Edit Strategy</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="custom-wrapper mb-3">
                            <input type="hidden" name="strategy-id">
                            <input type="hidden" name="strategy-uid">
                            <div class="p-3"><label class="form-label">Name</label><input name="strategy-name" type="text" class="form-control"></div>
                            <div class="p-3"><label class="form-label">Description</label><textarea name="strategy-description" class="form-control"></textarea></div>
                            <div class="p-3"><label class="form-label">Content</label></div>
                            <div class="py-0 px-3 mb-0 opacity-50"><label>function update(player, table, unit) {</label></div>
                            <div class="custom p-3">
                                <pre class="editor mt-0">
                                </pre>
                            </div>
                            <div class="py-0 px-3 my-0 opacity-50"><label>}</label></div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-danger delete-button" data-bs-dismiss="modal">Delete</button>
                        <button type="button" class="btn btn-info debug-button">Debug</button>
                        <button type="button" class="btn btn-warning save-button disabled">Save</button>
                        <button type="button" class="btn btn-primary save-as-new-button disabled">Save As New</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <p>Update the contents of the textarea and select custom strategy above to see how it performs.</p>
        <script>

        const API = "https://www.bigjoe.org/chouette/api/strategy";

        const templatesEl = document.querySelector('div.templates');
        const strategyItemEl = templatesEl.querySelector('.strategy-item');
        const infoModalEl = document.querySelector('.templates div.info-modal');
        const editorModalEl = document.querySelector('.templates div.edit-modal');

        let strategiesEl = document.querySelector('div.strategies');
        let logEl = document.querySelector('div.printout');
        let statusEl = document.querySelector('div.status');
        document.querySelector('button.doit').addEventListener('click', setItUp);

        let uid;
        addLoadedCallback(user=>{
            uid = user.uid;
        })
        addLoadedCallback(loadStrategies);

        function loadStrategies() {
            removeChildren(strategiesEl);
            // Do user strategies, then in callback fetch system strategies
            makeApiCall({url:API + '/list', callback:resp=>{
                resp.forEach(addStrategy);
                makeApiCall({url:API + '/listSystem', callback:resp=>resp.forEach(addStrategy)});
            }})
        }

        function addStrategy(strategy) {
            let el = strategyItemEl.cloneNode(true);
                    strategiesEl.appendChild(el);
                    el.querySelector('.strategy-name').innerText = strategy.name;
                    el.querySelector('.is-system').innerText = strategy.uid ? '' : 'system';

                    let inputEl = el.querySelector('input.hidden');
                    inputEl.value = strategy.id;
                    inputEl.dataset.content = strategy.content;
                    inputEl.dataset.name = strategy.name;

                    el.querySelector('.info-button').addEventListener('click', e=>{
                        console.log('clicked');
                        e.stopPropagation();
                        let infoEl = infoModalEl.cloneNode(true);
                        infoEl.querySelector('.strategy-name').innerText = strategy.name;
                        infoEl.querySelector('.strategy-description').innerText = strategy.description;
                        infoEl.querySelector('.strategy-content').innerText = strategy.content;
                        bootstrap.Modal.getOrCreateInstance(infoEl).show();

                        infoEl.querySelector('.edit-button').addEventListener('click', ()=>{
                            console.log('clicked edit button');
                            let editEl = editorModalEl.cloneNode(true);
                            let editor = window.ace.edit(editEl.querySelector('.editor'));
                            let saveButton = editEl.querySelector("button.save-button");
                            let saveAsNewButton = editEl.querySelector("button.save-as-new-button");
                            let debugButton = editEl.querySelector("button.debug-button");

                            editor.setTheme(`ace/theme/monokai`);
                            editor.session.setMode(`ace/mode/javascript`);
                            editor.setOptions({
                                enableBasicAutocompletion: true,
                                enableSnippets: true,
                                enableLiveAutocompletion: true,
                                wrap: true,
                                showLineNumbers: true
                            });

                            editor.setValue(js_beautify(strategy.content));
                            editor.on('change', data => {
                                saveButton.classList.add('disabled');
                                saveAsNewButton.classList.add('disabled');
                            });

                            debugButton.addEventListener('click', ()=>{
                                alert('not yet implemented');
                                saveButton.classList.remove('disabled');
                                saveAsNewButton.classList.remove('disabled');
                            })

                            editEl.querySelector('input[name=strategy-id]').value = strategy.id;
                            editEl.querySelector('input[name=strategy-uid]').value = strategy.uid;
                            editEl.querySelector('input[name=strategy-name]').value = strategy.name;
                            editEl.querySelector('textarea[name=strategy-description]').innerText = strategy.description;
                            editEl.querySelector('button.save-button').classList.toggle('hidden', !strategy.uid);
                            // modal.hide();
                            bootstrap.Modal.getOrCreateInstance(editEl).show();

                            editEl.querySelector('.delete-button').classList.toggle('hidden', !strategy.uid);
                            editEl.querySelector('.delete-button').addEventListener('click', ()=>{
                                makeApiCall(API + '/delete?id=' + strategy.id, 'POST');
                                loadStrategies();
                            })


                            editEl.querySelector("button.save-button").addEventListener('click', ()=>{
                                makeApiCall(API + '/save', 'POST', {
                                    id: editEl.querySelector('input[name=strategy-id]').value,
                                    uid: uid,
                                    name: editEl.querySelector('input[name=strategy-name]').value,
                                    description: editEl.querySelector('textarea[name=strategy-description]').value,
                                    content: js_beautify(editor.getValue())
                                    }, ()=>{
                                        bootstrap.Modal.getOrCreateInstance(editEl).hide();
                                        loadStrategies();
                                    }
                                )
                            });

                            editEl.querySelector("button.save-as-new-button").addEventListener('click', ()=>{
                                makeApiCall(API + '/save', 'POST', {
                                    uid: uid,
                                    name: editEl.querySelector('input[name=strategy-name]').value,
                                    description: editEl.querySelector('textarea[name=strategy-description]').value,
                                    content: js_beautify(editor.getValue())
                                    }, ()=>{
                                        bootstrap.Modal.getOrCreateInstance(editEl).hide();
                                        loadStrategies();
                                    }
                                )
                            });
                        })

                    });
                    el.addEventListener('click', ()=>{
                        inputEl.checked = !inputEl.checked;
                        el.classList.toggle('bg-primary');
                        el.classList.toggle('text-light');
                    })
        }

        function setItUp() {
            removeChildren(logEl);
            logs = [];

            if (!document.querySelector('input[name=once]').checked) {
                statusEl.innerText = 'Running Simulation';
            }
            setTimeout(doIt, 0);
        }

        function doIt() {
            let title = 'Strategy Comparison ' + new Date().toString() + ' ';
            let strategies = [];
            strategiesEl.querySelectorAll('input[type=checkbox]:checked').forEach(el=>{
                let strategy = new custom();
                strategy.name = el.dataset.name;
                strategies.push(strategy);
                strategy.update = Function("player", "table", "unit", "strategyInfo", el.dataset.content);
            });

            if (strategies.length == 0) {
                strategies = [new passline()];
            }
            let config = {
                numberOfRuns : document.querySelector('input[name=numberOfRuns]').value,
                maxRolls : document.querySelector('input[name=maxRolls]').value,
                maxShooters : document.querySelector('input[name=maxShooters]').value,
                bankroll : document.querySelector('input[name=bankroll]').value,
                'strategies' : strategies
            }
            let sim = new Simulation(config.numberOfRuns, config.maxRolls, config.maxShooters, config.bankroll, strategies);

            if (document.querySelector('input[name=once]').checked) {
                sim.printout();
                let line;
                while (logs.length) {
                    let el = document.createElement('div');
                    el.innerText = logs.shift();
                    logEl.appendChild(el);
                };
                return;
            }

            // Output is a dict of strategy names whose values are arrays of the form [simulationId, endingBankroll, StartingBankRoll, numberOfRoll]
            let output = sim.run();
            console.log(output);

            var data = new google.visualization.DataTable();
			data.addColumn('number', 'Win Amount');

            // Summarized will be dict of strategy names with values of dicts of ending backroll to number of times that occurred
            let summarized = {};
            let stats = {};
            let totals = {};
            let winCounts = {};
            let winTotals = {};
            let lossTotals = {};
            let max = -1;
            let min = Number.MAX_SAFE_INTEGER;
            Object.keys(output).forEach(k=>{
                data.addColumn('number', k);
                stats[k] = {
                    totals : 0,
                    winCounts : 0,
                    winTotals : 0,
                    lossCounts : 0,
                    lossTotals : 0
                }
                console.log('summarizing:' + k);
                summarized[k] = {};
                output[k].forEach(array=>{
                    let winAmount = parseInt(array[1]) - parseInt(array[2]);
                    summarized[k][winAmount] = summarized[k][winAmount] || 0;
                    summarized[k][winAmount] += 1;
                    stats[k]['totals'] += winAmount;
                    if (winAmount > 0) {
                        stats[k]['winCounts'] += 1;
                        stats[k]['winTotals'] += winAmount;
                    } else if (winAmount < 0) {
                        stats[k]['lossCounts'] += 1;
                        stats[k]['lossTotals'] += winAmount;
                    }
                    max = Math.max(max, winAmount);
                    min = Math.min(min, winAmount);
                })
            })

            console.log("Stats:");
            console.log(stats);
            console.log("Summarized:");
            console.log(summarized);

            for (let i = min; i <= max; i++) {
                let row = [i];
                Object.keys(output).forEach(k=>{
                    row.push(summarized[k][i] || null);
                })
                data.addRow(row);
            };
            google.charts.setOnLoadCallback(drawChart.bind(null, data, title, config, stats));
            statusEl.innerText = '';
        }

        function drawChart(data, title, config, stats) {
            //data = google.visualization.arrayToDataTable(data);
            let parentEl = document.querySelector('div.chart');
            let runEl = parentEl.insertBefore(document.createElement('div'), parentEl.firstChild);
            runEl.classList.add('run');
            let titleEl = runEl.appendChild(document.createElement('h2'));
            titleEl.innerText = title;
            titleEl.classList.add('center');
            let configEl = runEl.appendChild(document.createElement('pre'));
            let strategyNames = [];
            config.strategies.forEach(s=>
            strategyNames.push(s.name || s.constructor.name));
            config.strategies = strategyNames;
            configEl.innerText = JSON.stringify(config, null, 2);
            configEl.classList.add('center');
            let summaryEl = runEl.appendChild(document.createElement('table'));
            summaryEl.classList.add('center');
            let headEl = summaryEl.appendChild(document.createElement('tr'));
            headEl.appendChild(document.createElement('th')).innerText = 'Strategy Name';
            headEl.appendChild(document.createElement('th')).innerText = 'Average Win/Loss';
            headEl.appendChild(document.createElement('th')).innerText = 'Win Count';
            headEl.appendChild(document.createElement('th')).innerText = 'Win Average';
            headEl.appendChild(document.createElement('th')).innerText = 'Loss Count';
            headEl.appendChild(document.createElement('th')).innerText = 'Loss Average';
            
            config.strategies.forEach(s=>{
                let rowEl = summaryEl.appendChild(document.createElement('tr'));
                rowEl.appendChild(document.createElement('td')).innerText = s;
                rowEl.appendChild(document.createElement('td')).innerText = formatter.format(stats[s]['totals'] / config.numberOfRuns);
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['winCounts'];
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['winCounts'] == 0 ? formatter.format(0) : formatter.format(stats[s]['winTotals'] / stats[s]['winCounts']);
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['lossCounts'];
                rowEl.appendChild(document.createElement('td')).innerText = stats[s]['lossCounts'] == 0 ? formatter.format(0) : formatter.format(stats[s]['lossTotals'] / stats[s]['lossCounts']);
            })

            new google.visualization.LineChart(runEl.appendChild(document.createElement('div'), parentEl.firstChild)).draw(data, {
                curveType: 'function',
                legend: 'bottom',
                height: 400,
                interpolateNulls: true
            });
        }
        </script>
    </body>
</html>
